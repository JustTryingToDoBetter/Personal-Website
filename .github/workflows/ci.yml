name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DJANGO_SECRET_KEY: fo0dLov3R$
      DJANGO_DEBUG: 'False'
      DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1
      DATABASE_URL: sqlite:///./test.db
      CORS_ALLOW_ALL_ORIGINS: 'True'
      BASIC_AUTH_USER: admin
      BASIC_AUTH_PASS: p@$$w0Rd1209
      DJANGO_API_URL: http://localhost:8000/api

    steps:
      - uses: actions/checkout@v4

      # ---------- Node.js setup ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            middleware/package-lock.json
            frontend/package-lock.json

      - name: Install root dependencies
        run: npm install

      - name: Install middleware dependencies
        run: npm install --prefix middleware

      - name: Install frontend dependencies
        run: npm install --prefix frontend

      - name: Build Vue frontend
        run: npm run build --prefix frontend

      # ---------- Python setup ----------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # ---------- Django setup and tests ----------
      - name: Run Django migrations and checks
        run: |
          cd backend
          python manage.py collectstatic --noinput --clear
          python manage.py migrate --noinput
          python manage.py check

      # ---------- Optional: Add actual tests when ready ----------
      - name: Run backend tests (when implemented)
        run: |
          cd backend
          # python manage.py test
          echo "Backend tests: TODO - implement with 'python manage.py test'"

      - name: Frontend type checking (when implemented)
        run: |
          # npm run type-check --prefix frontend
          echo "Frontend type checking: TODO - implement with Vue/TypeScript"